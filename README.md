# openwrt-parental

## Parental Suite v2

A modern, API-first parental control suite for OpenWrt routers using `nftables` and `ubus`.

### Features

*   **Group-based Policies**: Assign clients (by MAC address) to groups.
*   **Time-based Scheduling**: Define multiple access schedules per group (e.g., different for weekdays and weekends).
*   **Manual Overrides**: Instantly block, unblock, or pause a client's internet access for a set duration.
*   **AdGuard Home Integration**: Syncs clients to AdGuard Home for DNS-level filtering.
*   **Web Interface**: A standalone dashboard with live refresh, usage graphs, quick actions, and full configuration editing (no manual UCI edits required).
*   **LAN Discovery**: Correlates DHCP leases, wireless associations, hostapd stations, and ARP/neighbor tables to surface active devices for fast onboarding.
*   **JSON/ubus API**: All functionality is exposed via `ubus` for easy integration and scripting.
*   **Health Monitoring**: An API endpoint to check the status of critical components.

### Quick Install

Run this command on your OpenWrt router to download the latest packaged release and execute the installer automatically. Missing prerequisites such as `curl`, `unzip`, `lua`, `uhttpd`, `uhttpd-mod-ubus`, and `luci-lib-jsonc` are installed on the fly via `opkg`:

```sh
sh -c "$(curl -fsSL https://raw.githubusercontent.com/sfdcai/openwrt-parental/main/bootstrap.sh)"
```

Environment variables allow you to pin a specific release (`VERSION="v2.0.0"`), override the download URL (`PKG_URL`), or keep the extracted payload for inspection (`KEEP_FILES=1`). If the packaged release asset is missing, the bootstrapper automatically falls back to the repository archive (main branch or tagged source) so the installer can still run. Set `BOOTSTRAP_SKIP_OPKG_UPDATE=1` (bootstrap) or `PARENTAL_SKIP_OPKG_UPDATE=1` (installer) to skip refreshing `opkg` indexes when mirrors are unreachable.

### Installation

1.  (Optional) Copy the `parental_suite_v2.zip` package (generated by `generate.sh`) to your router's `/tmp` directory.
    ```sh
    scp parental_suite_v2.zip root@<router-ip>:/tmp/
    ```

2.  SSH into your router and run the installer:
    ```sh
    ssh root@<router-ip>
    cd /tmp
    unzip -o parental_suite_v2.zip
    sh install.sh
    ```

3.  The web UI will be available at `http://<your-router-ip>:8088`.

The installer verifies and installs `uhttpd`, `uhttpd-mod-ubus`, `lua`, `luci-lib-jsonc`, and `curl` automatically before deploying the suite.

### Managing through the Web UI

Visit `http://<router-ip>:8088` to access the dashboard:

* **Dashboard** – Live client list with per-device actions, DNS query activity bars, and a searchable discovered-device explorer (with interface/source tags, last-seen hints, and one-click onboarding).
* **Groups** – Create, rename, or remove groups; configure DNS profiles, overlapping schedules, and optional daily quotas in minutes.
* **Settings** – Toggle enforcement, set the default policy, configure AdGuard Home, and manage Telegram credentials.
* **Theme** – Switch between light, dark, or auto; the preference is stored locally per browser.

Use the **Scan** button in the discovered-devices panel to force a fresh pull from DHCP, wireless, and neighbor sources; the search box filters by hostname, MAC, IP, interface, or data source.

Unsaved edits are highlighted in the header. Click **Save Configuration** to push changes via the `parental.save_config` ubus method and optionally reload rules with **Apply Rules**.

### Configuration

- The UI writes to `/etc/config/parental`; manual edits remain supported for automation or advanced workflows:
  - `config global 'settings'` → `default_policy 'allow'|'block'`, `adguard_url`, `adguard_token`, `telegram_token`, `telegram_chat_id`.
  - `config group '<id>'` → `option name`, `list schedule 'HH:MM-HH:MM;mon-fri'` (multiple allowed), optional `option quota_daily_min '<minutes>'`.
  - `config client` → `option mac`, `option name`, `option group`.

Example schedules:

- `07:00-20:30;mon-fri`
- `08:00-21:00;sat-sun`
- `09:00-18:00;mon,wed,fri`

### API (ubus)

Examples (from router):

- Overview
  `ubus call parental get_overview {}`

- Health
  `ubus call parental health {}`

- Apply nft rules
  `ubus call parental apply {}`

- Save configuration snapshot (used by the UI)
  `ubus call parental save_config '{"globals":{},"groups":[],"clients":[]}'`

- Pause a client for 30 minutes
  `ubus call parental pause_client '{"mac":"AA:BB:CC:DD:EE:01","duration":30}'`

- Block/Unblock now
  `ubus call parental block_client '{"mac":"AA:BB:CC:DD:EE:01"}'`
  `ubus call parental unblock_client '{"mac":"AA:BB:CC:DD:EE:01"}'`

- AdGuard querylog (latest 200)
  `ubus call parental adguard_querylog '{"limit":200}'`

### Telegram Bot

The optional Telegram bot polls for commands and translates them into the
matching `ubus` calls. Configure your bot token and an allowed chat ID in
`/etc/config/parental`:

```
config global 'settings'
  option telegram_token '123456789:ABC...'
  option telegram_chat_id '987654321'
```

Start the bot by running `/usr/share/parental/telegram/bot.sh` (use `procd`
or cron to keep it alive). Supported commands:

- `/status` – short overview of groups and clients
- `/pause <mac> [minutes]` – pause a client (default 30 minutes)
- `/block <mac>` / `/unblock <mac>`
- `/apply` – reapply nftables rules
- `/health` – returns the JSON health payload
- `/sync` – trigger AdGuard client synchronisation

### Notes

- Scheduler runs every minute via cron and enforces: pauses, schedules, and group daily quota minutes. Quota minutes are approximated using per-client nft counters by counting minutes with traffic.
- All scripts are idempotent; firewall modifications limit to a single jump from `fw4` to `inet parental usage` and a drop rule for the blocked set.
- The web UI is a static app served by `uhttpd` on port 8088.
