# openwrt-parental

## Parental Suite v2

A modern, API-first parental control suite for OpenWrt routers using `nftables` and `ubus`.

### Features

*   **Group-based Policies**: Assign clients (by MAC address) to groups.
*   **Time-based Scheduling**: Define multiple access schedules per group (e.g., different for weekdays and weekends).
*   **Manual Overrides**: Instantly block, unblock, or pause a client's internet access for a set duration.
*   **AdGuard Home Integration**: Syncs clients to AdGuard Home for DNS-level filtering.
*   **Web Interface**: A simple, standalone UI to view client status and perform actions.
*   **JSON/ubus API**: All functionality is exposed via `ubus` for easy integration and scripting.
*   **Health Monitoring**: An API endpoint to check the status of critical components.

### Installation

1.  You will need `unzip` and `curl` on your router. If not present, install them:
    ```sh
    opkg update && opkg install unzip curl
    ```

2.  Copy the `parental_suite_v2.zip` package (generated by `generate.sh`) to your router's `/tmp` directory.
    ```sh
    scp parental_suite_v2.zip root@192.168.1.1:/tmp/
    ```

3.  SSH into your router and run the installer:
    ```sh
    ssh root@192.168.1.1
    cd /tmp
    unzip -o parental_suite_v2.zip
    sh install.sh
    ```

4.  The web UI will be available at `http://<your-router-ip>:8088`.

### Configuration

- Edit `etc/config/parental` and tune:
  - `config global 'settings'` → `default_policy 'allow'|'deny'`, `adguard_url`, `adguard_token`.
  - `config group '<id>'` → `option name`, `list schedule 'HH:MM-HH:MM;mon-fri'` (multiple allowed), optional `option quota_daily_min '<minutes>'`.
  - `config client` → `option mac`, `option name`, `option group`.

Example schedules:

- `07:00-20:30;mon-fri`
- `08:00-21:00;sat-sun`
- `09:00-18:00;mon,wed,fri`

### API (ubus)

Examples (from router):

- Overview
  `ubus call parental get_overview {}`

- Health
  `ubus call parental health {}`

- Apply nft rules
  `ubus call parental apply {}`

- Pause a client for 30 minutes
  `ubus call parental pause_client '{"mac":"AA:BB:CC:DD:EE:01","duration":30}'`

- Block/Unblock now
  `ubus call parental block_client '{"mac":"AA:BB:CC:DD:EE:01"}'`
  `ubus call parental unblock_client '{"mac":"AA:BB:CC:DD:EE:01"}'`

- AdGuard querylog (latest 200)
  `ubus call parental adguard_querylog '{"limit":200}'`

### Notes

- Scheduler runs every minute via cron and enforces: pauses, schedules, and group daily quota minutes. Quota minutes are approximated using per-client nft counters by counting minutes with traffic.
- All scripts are idempotent; firewall modifications limit to a single jump from `fw4` to `inet parental usage` and a drop rule for the blocked set.
- The web UI is a static app served by BusyBox `httpd` on port 8088.
