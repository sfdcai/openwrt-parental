# openwrt-parental

## Parental Suite v2

A modern, API-first parental control suite for OpenWrt routers using `nftables` and `ubus`.

### Features

*   **Group-based Policies**: Assign clients (by MAC address) to groups.
*   **Time-based Scheduling**: Define multiple access schedules per group (e.g., different for weekdays and weekends).
*   **Manual Overrides**: Instantly block, unblock, or pause a client's internet access for a set duration.
*   **AdGuard Home Integration**: Syncs clients to AdGuard Home for DNS-level filtering.
*   **Web Interface**: A simple, standalone UI to view client status and perform actions.
*   **JSON/ubus API**: All functionality is exposed via `ubus` for easy integration and scripting.
*   **Health Monitoring**: An API endpoint to check the status of critical components.

### Quick Install

Run this command on your OpenWrt router to download the latest packaged release and execute the installer automatically (requires `curl`, `unzip`, and `mktemp` packages):

```sh
sh -c "$(curl -fsSL https://raw.githubusercontent.com/sfdcai/openwrt-parental/main/bootstrap.sh)"
```

Environment variables allow you to pin a specific release (`VERSION="v2.0.0"`), override the download URL (`PKG_URL`), or keep the extracted payload for inspection (`KEEP_FILES=1`). If the packaged release asset is missing, the bootstrapper automatically falls back to the repository archive (main branch or tagged source) so the installer can still run. The installer will install the `busybox-httpd` package via `opkg` if the embedded HTTP server is not available; set `PARENTAL_SKIP_OPKG_UPDATE=1` to bypass the package list refresh if your router cannot reach the mirrors.

### Installation

1.  You will need `unzip` and `curl` on your router. If not present, install them:
    ```sh
    opkg update && opkg install unzip curl
    ```

2.  Copy the `parental_suite_v2.zip` package (generated by `generate.sh`) to your router's `/tmp` directory.
    ```sh
    scp parental_suite_v2.zip root@<router-ip>:/tmp/
    ```

3.  SSH into your router and run the installer:
    ```sh
    ssh root@<router-ip>
    cd /tmp
    unzip -o parental_suite_v2.zip
    sh install.sh
    ```

4.  The web UI will be available at `http://<your-router-ip>:8088`.

### Configuration

- Edit `etc/config/parental` and tune:
  - `config global 'settings'` → `default_policy 'allow'|'deny'`, `adguard_url`, `adguard_token`.
  - `config group '<id>'` → `option name`, `list schedule 'HH:MM-HH:MM;mon-fri'` (multiple allowed), optional `option quota_daily_min '<minutes>'`.
  - `config client` → `option mac`, `option name`, `option group`.

Example schedules:

- `07:00-20:30;mon-fri`
- `08:00-21:00;sat-sun`
- `09:00-18:00;mon,wed,fri`

### API (ubus)

Examples (from router):

- Overview
  `ubus call parental get_overview {}`

- Health
  `ubus call parental health {}`

- Apply nft rules
  `ubus call parental apply {}`

- Pause a client for 30 minutes
  `ubus call parental pause_client '{"mac":"AA:BB:CC:DD:EE:01","duration":30}'`

- Block/Unblock now
  `ubus call parental block_client '{"mac":"AA:BB:CC:DD:EE:01"}'`
  `ubus call parental unblock_client '{"mac":"AA:BB:CC:DD:EE:01"}'`

- AdGuard querylog (latest 200)
  `ubus call parental adguard_querylog '{"limit":200}'`

### Telegram Bot

The optional Telegram bot polls for commands and translates them into the
matching `ubus` calls. Configure your bot token and an allowed chat ID in
`/etc/config/parental`:

```
config global 'settings'
  option telegram_token '123456789:ABC...'
  option telegram_chat_id '987654321'
```

Start the bot by running `/usr/share/parental/telegram/bot.sh` (use `procd`
or cron to keep it alive). Supported commands:

- `/status` – short overview of groups and clients
- `/pause <mac> [minutes]` – pause a client (default 30 minutes)
- `/block <mac>` / `/unblock <mac>`
- `/apply` – reapply nftables rules
- `/health` – returns the JSON health payload
- `/sync` – trigger AdGuard client synchronisation

### Notes

- Scheduler runs every minute via cron and enforces: pauses, schedules, and group daily quota minutes. Quota minutes are approximated using per-client nft counters by counting minutes with traffic.
- All scripts are idempotent; firewall modifications limit to a single jump from `fw4` to `inet parental usage` and a drop rule for the blocked set.
- The web UI is a static app served by BusyBox `httpd` on port 8088.
