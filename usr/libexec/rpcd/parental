#!/usr/bin/lua
-- rpcd plugin providing parental.* methods
local json = require "luci.jsonc"

local function sh(cmd)
  local f = io.popen(cmd .. " 2>&1")
  if not f then return "" end
  local out = f:read("*a")
  f:close()
  return out or ""
end

local function trim(s)
  return (s or ""):gsub("^%s+", ""):gsub("%s+$", "")
end

local function parse_uci()
  local out = sh("uci -q show parental")
  local globals = {}
  local raw_groups = {}
  local raw_clients = {}
  local group_order = {}
  local client_order = {}

  local function ensure_group(section)
    if not raw_groups[section] then
      raw_groups[section] = { section = section, schedule = {}, clients = {} }
      table.insert(group_order, section)
    end
    return raw_groups[section]
  end

  local function ensure_client(section)
    if not raw_clients[section] then
      raw_clients[section] = { section = section }
      table.insert(client_order, section)
    end
    return raw_clients[section]
  end

  for line in out:gmatch("[^\n]+") do
    repeat
      local section, stype = line:match("^parental%.([^.=]+)=(%w+)$")
      if section and stype == "group" then
        local g = ensure_group(section)
        g.type = stype
        break
      elseif section and stype == "client" then
        local c = ensure_client(section)
        c.type = stype
        break
      end

      local key, value = line:match("^parental%.settings%.([^.=]+)='(.-)'$")
      if key then
        globals[key] = value
        break
      end

      local sec, opt, val = line:match("^parental%.([^.=]+)%.([^.=]+)='(.-)'$")
      if sec and sec ~= "settings" then
        local target = "group"
        if (raw_clients[sec] and raw_clients[sec].type == "client") or opt == "mac" or opt == "pause_until" or opt == "group" then
          target = "client"
        elseif raw_groups[sec] and raw_groups[sec].type == "group" then
          target = "group"
        end

        if target == "group" then
          local g = ensure_group(sec)
          if opt == "schedule" then
            table.insert(g.schedule, val)
          elseif opt == "clients" then
            table.insert(g.clients, val)
          else
            g[opt] = val
          end
        else
          local c = ensure_client(sec)
          if opt == "mac" then
            c.mac = val
          elseif opt == "name" then
            c.name = val
          elseif opt == "group" then
            c.group = val
          elseif opt == "pause_until" then
            c.pause_until = val
          end
        end
        break
      end
    until true
  end

  local groups_map = {}
  local groups_list = {}
  for _, section in ipairs(group_order) do
    local g = raw_groups[section]
    if g and (g.type == "group" or section:match("@group%[")) then
      local name = g.name or g[".name"] or section
      local entry = {
        id = section,
        section = section,
        name = name,
        dns_profile = g.dns_profile,
        schedule = g.schedule or {},
        clients = g.clients or {},
        quota_daily_min = g.quota_daily_min and tonumber(g.quota_daily_min) or nil
      }
      groups_map[section] = entry
      table.insert(groups_list, entry)
    end
  end

  local clients_map = {}
  local clients_list = {}
  for _, section in ipairs(client_order) do
    local c = raw_clients[section]
    if c and (c.type == "client" or section:match("@client%[")) then
      local mac = (c.mac or ""):upper()
      if mac ~= "" then
        local entry = {
          id = section,
          section = section,
          mac = mac,
          name = c.name,
          group = c.group,
          pause_until = c.pause_until and tonumber(c.pause_until) or nil
        }
        clients_map[mac] = entry
        table.insert(clients_list, entry)
      end
    end
  end

  return {
    globals = globals,
    groups = groups_map,
    groups_list = groups_list,
    clients = clients_map,
    clients_list = clients_list
  }
end

local function merge_fields(target, fields)
  for k, v in pairs(fields) do
    if v and v ~= "" and (not target[k] or target[k] == "") then
      target[k] = v
    end
  end
end

local function gather_discovered()
  local discovered = {}
  local seen = {}
  local function add(mac, fields)
    mac = (mac or ""):upper()
    if mac == "" then return end
    local entry = seen[mac]
    if not entry then
      entry = { mac = mac }
      seen[mac] = entry
      table.insert(discovered, entry)
    end
    merge_fields(entry, fields)
  end

  local status_raw = sh("ubus call network.interface.lan status")
  local ok, status = pcall(json.parse, status_raw)
  if ok and type(status) == "table" then
    local neighbors = status.neighbors or status.neighbor
    if type(neighbors) == "table" then
      for _, n in ipairs(neighbors) do
        if type(n) == "table" then
          add(n.lladdr or n.mac or n["mac-address"], {
            ip = n.ip or n.ipv4 or n.address,
            hostname = n.host or n.name,
            source = n.source or "lan"
          })
        end
      end
    end
    local dhcp = status["dhcp-server"]
    if type(dhcp) == "table" and type(dhcp.clients) == "table" then
      for _, c in ipairs(dhcp.clients) do
        if type(c) == "table" then
          add(c.mac or c.hwaddr, {
            ip = c.ip or c["ipv4-address"],
            hostname = c.name,
            source = "dhcp"
          })
        end
      end
    end
  end

  local f = io.open("/tmp/dhcp.leases", "r")
  if f then
    for line in f:lines() do
      local _, mac, ip, host = line:match("^(%S+)%s+(%S+)%s+(%S+)%s+(%S+)")
      add(mac, { ip = ip, hostname = host ~= "*" and host or nil, source = "dhcp" })
    end
    f:close()
  end

  return discovered
end

local function uci_quote(v)
  if v == nil then
    return '""'
  end
  return string.format("%q", tostring(v))
end

local function run_batch(commands)
  local pipe = io.popen("uci batch", "w")
  if not pipe then return false end
  for _, cmd in ipairs(commands) do
    pipe:write(cmd)
    pipe:write("\n")
  end
  pipe:write("commit parental\n")
  pipe:close()
  return true
end

local function save_config(args)
  local globals = {}
  if type(args.globals) == "table" then globals = args.globals end
  local groups = {}
  if type(args.groups) == "table" then groups = args.groups end
  local clients = {}
  if type(args.clients) == "table" then clients = args.clients end

  local function norm_key(v)
    return (tostring(v or ""):lower())
  end

  local used_alias = {}
  local alias_for_index = {}
  local alias_lookup = {}

  local function map_alias(value, alias)
    local k = norm_key(value)
    if k and k ~= "" and not alias_lookup[k] then
      alias_lookup[k] = alias
    end
  end

  for idx, group in ipairs(groups) do
    if type(group) ~= "table" then group = {} end
    local raw = group.section or group.id or group.name or string.format("group%d", idx)
    raw = tostring(raw)
    raw = raw:gsub("%s+", "-")
    local candidate = raw:lower():gsub("[^a-z0-9_%-]", "")
    if candidate == "" then
      candidate = string.format("group%d", idx)
    end
    local final = candidate
    local n = 1
    while used_alias[final] do
      n = n + 1
      final = string.format("%s%d", candidate, n)
    end
    used_alias[final] = true
    alias_for_index[idx] = final
    map_alias(group.section, final)
    map_alias(group.id, final)
    map_alias(group.name, final)
    map_alias(candidate, final)
    map_alias(final, final)
    groups[idx] = group
    group.section = final
  end

  local group_clients = {}
  for _, client in ipairs(clients) do
    if type(client) == "table" then
      local gk = alias_lookup[norm_key(client.group)] or norm_key(client.group)
      local mac = client.mac and client.mac:upper() or ""
      if gk and gk ~= "" and mac ~= "" then
        group_clients[gk] = group_clients[gk] or {}
        table.insert(group_clients[gk], mac)
      end
    end
  end

  local commands = { "delete parental", "set parental.settings=global" }

  for key, value in pairs(globals) do
    if value ~= nil then
      table.insert(commands, string.format("set parental.settings.%s=%s", key, uci_quote(value)))
    end
  end

  for idx, group in ipairs(groups) do
    if type(group) == "table" then
      local alias = alias_for_index[idx] or group.section or string.format("group%d", idx)
      local prefix = string.format("parental.%s", alias)
      table.insert(commands, string.format("set %s=group", prefix))
      if group.name then
        table.insert(commands, string.format("set %s.name=%s", prefix, uci_quote(group.name)))
      end
      if group.dns_profile then
        table.insert(commands, string.format("set %s.dns_profile=%s", prefix, uci_quote(group.dns_profile)))
      end
      if group.quota_daily_min then
        table.insert(commands, string.format("set %s.quota_daily_min=%s", prefix, uci_quote(group.quota_daily_min)))
      end
      if type(group.schedule) == "table" then
        for _, sched in ipairs(group.schedule) do
          if sched and sched ~= "" then
            table.insert(commands, string.format("add_list %s.schedule=%s", prefix, uci_quote(sched)))
          end
        end
      end
      local assigned = group_clients[alias]
      if type(assigned) == "table" then
        for _, mac in ipairs(assigned) do
          if mac and mac ~= "" then
            table.insert(commands, string.format("add_list %s.clients=%s", prefix, uci_quote(mac)))
          end
        end
      end
    end
  end

  for _, client in ipairs(clients) do
    if type(client) == "table" then
      local mac = client.mac and client.mac:upper() or ""
      if mac ~= "" then
        table.insert(commands, "add parental client")
        table.insert(commands, string.format("set parental.@client[-1].mac=%s", uci_quote(mac)))
        if client.name then
          table.insert(commands, string.format("set parental.@client[-1].name=%s", uci_quote(client.name)))
        end
        local galias = alias_lookup[norm_key(client.group)] or client.group
        if galias and galias ~= "" then
          table.insert(commands, string.format("set parental.@client[-1].group=%s", uci_quote(galias)))
        end
        if client.pause_until then
          table.insert(commands, string.format("set parental.@client[-1].pause_until=%s", uci_quote(client.pause_until)))
        end
      end
    end
  end

  if not run_batch(commands) then
    return false, "uci batch failed"
  end
  return true
end

local M, methods = {}, {}

methods.get_overview = {
  args = {},
  call = function()
    local data = parse_uci()
    data.discovered = gather_discovered()
    return 0, data
  end
}

methods.apply = {
  args = {},
  call = function()
    return 0, { out = sh("/usr/share/parental/scripts/apply.sh reload") }
  end
}

methods.health = {
  args = {},
  call = function()
    local raw = sh("/usr/share/parental/scripts/health.sh")
    local ok, parsed = pcall(json.parse, raw)
    if ok and parsed then return 0, parsed end
    return 0, { raw = raw }
  end
}

methods.sync_adguard = {
  args = {},
  call = function()
    return 0, { out = sh("/usr/share/parental/scripts/adguard_sync.sh") }
  end
}

methods.pause_client = {
  args = { mac = "string", duration = "integer" },
  call = function(a)
    local mac = trim(a.mac or "")
    local dur = tonumber(a.duration or 0) or 0
    if mac == "" or dur <= 0 then return 1 end
    local out = sh(string.format("/usr/share/parental/scripts/pause.sh %s %d", mac, dur))
    return 0, { out = out }
  end
}

methods.block_client = {
  args = { mac = "string" },
  call = function(a)
    local mac = trim(a.mac or "")
    if mac == "" then return 1 end
    local out = sh(string.format("/usr/share/parental/scripts/block_now.sh %s", mac))
    return 0, { out = out }
  end
}

methods.unblock_client = {
  args = { mac = "string" },
  call = function(a)
    local mac = trim(a.mac or "")
    if mac == "" then return 1 end
    local out = sh(string.format("/usr/share/parental/scripts/unblock_now.sh %s", mac))
    return 0, { out = out }
  end
}

methods.adguard_querylog = {
  args = { limit = "integer" },
  call = function(a)
    local limit = tonumber(a.limit or 200) or 200
    local url = sh("uci -q get parental.settings.adguard_url"):gsub("\n$", "")
    local tok = sh("uci -q get parental.settings.adguard_token"):gsub("\n$", "")
    if url == "" then return 0, { entries = {} } end
    local cmd = string.format("/usr/bin/curl -sS -H 'Authorization: Bearer %s' '%s/control/querylog?offset=0&limit=%d'", tok, url, limit)
    local raw = sh(cmd)
    local ok, parsed = pcall(json.parse, raw)
    if ok and parsed and parsed.data then return 0, { entries = parsed.data } end
    return 0, { raw = raw }
  end
}

methods.save_config = {
  args = { globals = "table", groups = "table", clients = "table" },
  call = function(a)
    local ok, err = save_config(a)
    if not ok then
      return 1, { error = err or "failed" }
    end
    if a.apply_now == 1 or a.apply_now == true then
      sh("/usr/share/parental/scripts/apply.sh reload")
    end
    return 0, { status = "ok" }
  end
}

function M.list(t)
  for k, _ in pairs(methods) do table.insert(t, k) end
  return 0
end

function M.call(method, args)
  local fn = methods[method]
  if not fn then return 1 end
  return fn.call(args or {})
end

return M
